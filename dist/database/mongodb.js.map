{"version":3,"sources":["../../src/database/mongodb.ts"],"names":["MongoClient"],"mappings":";;;;;AAIA,IAAI,YAAA,GAAmC,IAAA;AACvC,IAAI,QAAA,GAAsB,IAAA;AAc1B,eAAsB,iBAAA,CACpB,OAAA,GAAoC,EAAC,EACrC;AACA,EAAA,MAAM,WAAA,GAAc,OAAA,CAAQ,GAAA,IAAO,OAAA,CAAQ,GAAA,CAAI,WAAA;AAC/C,EAAA,MAAM,UAAA,GAAa,OAAA,CAAQ,MAAA,IAAU,OAAA,CAAQ,IAAI,UAAA,IAAc,UAAA;AAE/D,EAAA,OAAA,CAAQ,GAAA,CAAI,6CAAA,EAA+C,OAAA,CAAQ,MAAA,IAAU,eAAe,CAAA;AAC5F,EAAA,OAAA,CAAQ,GAAA,CAAI,2BAAA,EAA6B,OAAA,CAAQ,GAAA,CAAI,cAAc,SAAS,CAAA;AAC5E,EAAA,OAAA,CAAQ,GAAA,CAAI,6BAA6B,UAAU,CAAA;AAEnD,EAAA,IAAI,CAAC,WAAA,EAAa;AAChB,IAAA,MAAM,IAAI,MAAM,oDAAoD,CAAA;AAAA,EACtE;AAGA,EAAA,IAAI,gBAAgB,QAAA,EAAU;AAC5B,IAAA,OAAA,CAAQ,GAAA,CAAI,gDAAA,EAAkD,QAAA,CAAS,YAAY,CAAA;AAEnF,IAAA,IAAI;AACF,MAAA,MAAM,YAAA,CAAa,EAAA,EAAG,CAAE,KAAA,GAAQ,IAAA,EAAK;AACrC,MAAA,OAAO,EAAE,MAAA,EAAQ,YAAA,EAAc,EAAA,EAAI,QAAA,EAAS;AAAA,IAC9C,SAAS,KAAA,EAAO;AACd,MAAA,OAAA,CAAQ,IAAI,oDAAoD,CAAA;AAEhE,MAAA,YAAA,GAAe,IAAA;AACf,MAAA,QAAA,GAAW,IAAA;AAAA,IACb;AAAA,EACF;AAGA,EAAA,OAAA,CAAQ,IAAI,oCAAoC,CAAA;AAChD,EAAA,MAAM,MAAA,GAAS,IAAIA,mBAAA,CAAY,WAAA,EAAa;AAAA,IAC1C,wBAAA,EAA0B,QAAQ,wBAAA,IAA4B,GAAA;AAAA,IAC9D,MAAA,EAAQ,QAAQ,MAAA,IAAU;AAAA,GAC3B,CAAA;AAED,EAAA,IAAI;AACF,IAAA,MAAM,OAAO,OAAA,EAAQ;AACrB,IAAA,MAAM,EAAA,GAAK,MAAA,CAAO,EAAA,CAAG,UAAU,CAAA;AAG/B,IAAA,YAAA,GAAe,MAAA;AACf,IAAA,QAAA,GAAW,EAAA;AAEX,IAAA,OAAA,CAAQ,GAAA,CAAI,+CAAA,EAAiD,EAAA,CAAG,YAAY,CAAA;AAC5E,IAAA,OAAO,EAAE,QAAQ,EAAA,EAAG;AAAA,EACtB,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,iCAAiC,KAAK,CAAA;AACpD,IAAA,MAAM,IAAI,KAAA;AAAA,MACR,CAAA,2BAAA,EACE,KAAA,YAAiB,KAAA,GAAQ,KAAA,CAAM,UAAU,eAC3C,CAAA;AAAA,KACF;AAAA,EACF;AACF;AAKA,eAAsB,eAAA,GAAkB;AACtC,EAAA,IAAI,YAAA,EAAc;AAChB,IAAA,MAAM,aAAa,KAAA,EAAM;AACzB,IAAA,YAAA,GAAe,IAAA;AACf,IAAA,QAAA,GAAW,IAAA;AACX,IAAA,OAAA,CAAQ,IAAI,2BAA2B,CAAA;AAAA,EACzC;AACF;AAOO,SAAS,wBAAwB,MAAA,EAAuB;AAC7D,EAAA,OAAO,MAAM,kBAAkB,MAAM,CAAA;AACvC","file":"mongodb.js","sourcesContent":["import { MongoClient, Db } from 'mongodb';\nimport type { MongoDBConfig } from './types';\n\n// MongoDB connection caching\nlet cachedClient: MongoClient | null = null;\nlet cachedDb: Db | null = null;\n\nexport interface ConnectToDatabaseOptions {\n  uri?: string;\n  dbName?: string;\n  serverSelectionTimeoutMS?: number;\n  family?: 4 | 6;\n}\n\n/**\n * Connect to MongoDB with connection pooling and health checks\n * @param options - Connection options\n * @returns MongoDB client and database\n */\nexport async function connectToDatabase(\n  options: ConnectToDatabaseOptions = {}\n) {\n  const MONGODB_URI = options.uri || process.env.MONGODB_URI;\n  const MONGODB_DB = options.dbName || process.env.MONGODB_DB || 'database';\n\n  console.log('[MongoDB] Connection requested with dbName:', options.dbName || 'not specified');\n  console.log('[MongoDB] MONGODB_DB env:', process.env.MONGODB_DB || 'not set');\n  console.log('[MongoDB] Using database:', MONGODB_DB);\n\n  if (!MONGODB_URI) {\n    throw new Error('Please define the MONGODB_URI environment variable');\n  }\n\n  // Check if we have a cached connection\n  if (cachedClient && cachedDb) {\n    console.log('[MongoDB] Using cached connection to database:', cachedDb.databaseName);\n    // Verify the connection is still alive\n    try {\n      await cachedClient.db().admin().ping();\n      return { client: cachedClient, db: cachedDb };\n    } catch (error) {\n      console.log('Cached MongoDB connection is dead, reconnecting...');\n      // Connection is dead, reset cache\n      cachedClient = null;\n      cachedDb = null;\n    }\n  }\n\n  // Create new connection\n  console.log('[MongoDB] Connecting to MongoDB...');\n  const client = new MongoClient(MONGODB_URI, {\n    serverSelectionTimeoutMS: options.serverSelectionTimeoutMS || 5000,\n    family: options.family || 4,\n  });\n\n  try {\n    await client.connect();\n    const db = client.db(MONGODB_DB);\n\n    // Cache the successful connection\n    cachedClient = client;\n    cachedDb = db;\n\n    console.log('[MongoDB] Successfully connected to database:', db.databaseName);\n    return { client, db };\n  } catch (error) {\n    console.error('Failed to connect to MongoDB:', error);\n    throw new Error(\n      `MongoDB connection failed: ${\n        error instanceof Error ? error.message : 'Unknown error'\n      }`\n    );\n  }\n}\n\n/**\n * Close the MongoDB connection (for cleanup)\n */\nexport async function closeConnection() {\n  if (cachedClient) {\n    await cachedClient.close();\n    cachedClient = null;\n    cachedDb = null;\n    console.log('MongoDB connection closed');\n  }\n}\n\n/**\n * Create a MongoDB connection factory with custom config\n * @param config - MongoDB configuration\n * @returns Connection function\n */\nexport function createMongoDBConnection(config: MongoDBConfig) {\n  return () => connectToDatabase(config);\n}\n"]}