{"version":3,"sources":["../../src/database/mongodb.ts","../../src/database/newsletter.ts"],"names":[],"mappings":"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","file":"index.mjs","sourcesContent":["import { MongoClient, Db } from 'mongodb';\nimport type { MongoDBConfig } from './types';\n\n// MongoDB connection caching\nlet cachedClient: MongoClient | null = null;\nlet cachedDb: Db | null = null;\n\nexport interface ConnectToDatabaseOptions {\n  uri?: string;\n  dbName?: string;\n  serverSelectionTimeoutMS?: number;\n  family?: 4 | 6;\n}\n\n/**\n * Connect to MongoDB with connection pooling and health checks\n * @param options - Connection options\n * @returns MongoDB client and database\n */\nexport async function connectToDatabase(\n  options: ConnectToDatabaseOptions = {}\n) {\n  const MONGODB_URI = options.uri || process.env.MONGODB_URI;\n  const MONGODB_DB = options.dbName || process.env.MONGODB_DB || 'database';\n\n  console.log('[MongoDB] Connection requested with dbName:', options.dbName || 'not specified');\n  console.log('[MongoDB] MONGODB_DB env:', process.env.MONGODB_DB || 'not set');\n  console.log('[MongoDB] Using database:', MONGODB_DB);\n\n  if (!MONGODB_URI) {\n    throw new Error('Please define the MONGODB_URI environment variable');\n  }\n\n  // Check if we have a cached connection\n  if (cachedClient && cachedDb) {\n    console.log('[MongoDB] Using cached connection to database:', cachedDb.databaseName);\n    // Verify the connection is still alive\n    try {\n      await cachedClient.db().admin().ping();\n      return { client: cachedClient, db: cachedDb };\n    } catch (error) {\n      console.log('Cached MongoDB connection is dead, reconnecting...');\n      // Connection is dead, reset cache\n      cachedClient = null;\n      cachedDb = null;\n    }\n  }\n\n  // Create new connection\n  console.log('[MongoDB] Connecting to MongoDB...');\n  const client = new MongoClient(MONGODB_URI, {\n    serverSelectionTimeoutMS: options.serverSelectionTimeoutMS || 5000,\n    family: options.family || 4,\n  });\n\n  try {\n    await client.connect();\n    const db = client.db(MONGODB_DB);\n\n    // Cache the successful connection\n    cachedClient = client;\n    cachedDb = db;\n\n    console.log('[MongoDB] Successfully connected to database:', db.databaseName);\n    return { client, db };\n  } catch (error) {\n    console.error('Failed to connect to MongoDB:', error);\n    throw new Error(\n      `MongoDB connection failed: ${\n        error instanceof Error ? error.message : 'Unknown error'\n      }`\n    );\n  }\n}\n\n/**\n * Close the MongoDB connection (for cleanup)\n */\nexport async function closeConnection() {\n  if (cachedClient) {\n    await cachedClient.close();\n    cachedClient = null;\n    cachedDb = null;\n    console.log('MongoDB connection closed');\n  }\n}\n\n/**\n * Create a MongoDB connection factory with custom config\n * @param config - MongoDB configuration\n * @returns Connection function\n */\nexport function createMongoDBConnection(config: MongoDBConfig) {\n  return () => connectToDatabase(config);\n}\n","import { connectToDatabase } from './mongodb';\nimport type { NewsletterSubscriber } from './types';\n\nexport interface NewsletterServiceConfig {\n  collectionName?: string;\n  dbName?: string;\n}\n\n/**\n * Newsletter subscription service\n */\nexport class NewsletterService {\n  private collectionName: string;\n  private dbName?: string;\n\n  constructor(config: NewsletterServiceConfig = {}) {\n    this.collectionName = config.collectionName || 'newsletter_subscribers';\n    this.dbName = config.dbName;\n  }\n\n  /**\n   * Subscribe a new email to the newsletter\n   */\n  async subscribe(\n    email: string,\n    metadata?: { userAgent: string; ip: string }\n  ): Promise<{ id: string; message: string }> {\n    if (!email) {\n      throw new Error('Email is required');\n    }\n\n    // Basic email validation\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    if (!emailRegex.test(email)) {\n      throw new Error('Invalid email format');\n    }\n\n    const { db } = await connectToDatabase({ dbName: this.dbName });\n    const collection = db.collection<NewsletterSubscriber>(this.collectionName);\n\n    // Check if email already exists\n    const existingSubscriber = await collection.findOne({ email });\n\n    if (existingSubscriber) {\n      // If already subscribed but inactive, reactivate\n      if (!existingSubscriber.active) {\n        await collection.updateOne(\n          { email },\n          {\n            $set: {\n              active: true,\n              resubscribedAt: new Date(),\n            },\n          }\n        );\n        return {\n          id: existingSubscriber._id?.toString() || '',\n          message: 'Successfully resubscribed to newsletter',\n        };\n      }\n\n      throw new Error('Email already subscribed');\n    }\n\n    // Insert new subscriber\n    const result = await collection.insertOne({\n      email,\n      subscribedAt: new Date(),\n      active: true,\n      source: 'website',\n      metadata,\n    });\n\n    return {\n      id: result.insertedId.toString(),\n      message: 'Successfully subscribed to newsletter',\n    };\n  }\n\n  /**\n   * Unsubscribe an email from the newsletter (soft delete)\n   */\n  async unsubscribe(email: string): Promise<{ message: string }> {\n    if (!email) {\n      throw new Error('Email is required');\n    }\n\n    const { db } = await connectToDatabase({ dbName: this.dbName });\n    const collection = db.collection<NewsletterSubscriber>(this.collectionName);\n\n    // Soft delete - mark as inactive instead of removing\n    const result = await collection.updateOne(\n      { email },\n      {\n        $set: {\n          active: false,\n          unsubscribedAt: new Date(),\n        },\n      }\n    );\n\n    if (result.matchedCount === 0) {\n      throw new Error('Email not found');\n    }\n\n    return { message: 'Successfully unsubscribed from newsletter' };\n  }\n\n  /**\n   * Get all active subscribers\n   */\n  async getActiveSubscribers(): Promise<NewsletterSubscriber[]> {\n    const { db } = await connectToDatabase({ dbName: this.dbName });\n    const collection = db.collection<NewsletterSubscriber>(this.collectionName);\n\n    return collection.find({ active: true }).toArray();\n  }\n\n  /**\n   * Get subscriber count\n   */\n  async getSubscriberCount(): Promise<number> {\n    const { db } = await connectToDatabase({ dbName: this.dbName });\n    const collection = db.collection<NewsletterSubscriber>(this.collectionName);\n\n    return collection.countDocuments({ active: true });\n  }\n}\n\n/**\n * Create a newsletter service instance\n */\nexport function createNewsletterService(config?: NewsletterServiceConfig) {\n  return new NewsletterService(config);\n}\n"]}